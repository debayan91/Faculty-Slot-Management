
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    function isAdmin() {
      // In a real app, this would be: return request.auth.token.role == 'admin';
      return request.auth != null;
    }

    // FACULTY PROFILES
    match /faculties/{userId} {
      // A user can create their own faculty profile
      allow create: if isOwner(userId);
      // Any authenticated user can read any faculty profile
      allow read: if request.auth != null;
      // Admins can read/write any faculty profile
      allow write: if isAdmin();
    }
    
    // SCHEDULE TEMPLATES
    match /schedule_templates/{day} {
        // Only admins can create, read or modify the daily templates
        allow read, write: if isAdmin();
    }

    // SLOTS
    match /slots/{slotId} {
      // Any authenticated user can read slots
      allow read: if request.auth != null;
      
      // Admins have full write access (create, update, delete) to all slots.
      // This is necessary for generating/deleting schedules and editing cell data.
      allow write: if isAdmin();

      // A user can book a slot (update) only if it's bookable, not already booked,
      // and they are setting their own ID as the 'booked_by' field.
      allow update: if request.auth != null
                    && resource.data.is_bookable == true
                    && resource.data.is_booked == false
                    && request.resource.data.is_booked == true
                    && request.resource.data.booked_by == request.auth.uid; // Assuming booked_by stores userId
    }
  }
}
